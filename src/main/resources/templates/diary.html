<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>앨범</title>
    <link rel="stylesheet" href="css/diary.css">
</head>
<body>
<div class="album" id="album"></div>
<form id="imageForm">
    <button type="button" class="upload-button" onclick="submitSelectedImages()">추억 저장하기</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const albumContainer = document.getElementById('album');
        let i = 1;

        const loadImages = () => {
            const imageUrl = `diary/${i}.jpg`; // 이미지 경로 설정
            fetch(imageUrl)
                .then(response => {
                    if (!response.ok) throw new Error("이미지 없음");

                    const imgElement = document.createElement('img');
                    imgElement.src = imageUrl;
                    imgElement.alt = `Album Image ${i}`;

                    const frameElement = document.createElement('div');
                    frameElement.className = 'frame';
                    frameElement.onclick = function () {
                        this.classList.toggle('selected');
                    };

                    const checkmarkElement = document.createElement('div');
                    checkmarkElement.className = 'checkmark';
                    checkmarkElement.textContent = '✔';

                    frameElement.appendChild(imgElement);
                    frameElement.appendChild(checkmarkElement);
                    albumContainer.appendChild(frameElement);

                    i++;
                    loadImages(); // 다음 이미지 로드
                })
                .catch(error => {
                    console.log("더 이상 이미지가 없습니다.");
                });
        };

        loadImages();
    });

    async function submitSelectedImages() {
        const selectedItems = [];

        const dummyText = "이것은 더미 텍스트입니다.";  // 더미 텍스트

        for (const frame of document.querySelectorAll('.frame.selected')) {
            const img = frame.querySelector('img');
            selectedItems.push({
                imageUrl: img.src,
                hashTag: "#추억",
                text: dummyText
            });
        }

        // context path가 포함된 경로로 요청을 보냅니다.
        const response = await fetch('/demo/saveImageTextBatch', {  // '/demo' 추가됨
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(selectedItems)
        });

        if (!response.ok) {
            console.error('Error:', response.statusText);
            return;
        }

        const data = await response.json();
        console.log('Data saved:', data);

        if (data.status === 'success') {
            window.location.href = '/demo/standby';  // standby 페이지로 이동 시에도 context path 포함
        }
    }

</script>
</body>
</html>